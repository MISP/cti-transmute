{% extends 'base.html' %}

{% block content %}
<div class="container mt-5" id="main-container">
    <template v-if="is_loading">
        <div class="text-center text-muted mt-5">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p class="mt-3">Loading...</p>
        </div>
    </template>
    <template v-else>
        <div class="custom-card shadow-sm p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>{{ convert_obj.name }}</h2>
            </div>

            <div class="card mb-4"
                style="background-color: var(--color-sidebar); color: var(--color-text); border: 1px solid var(--color-navbar);">
                <div class="card-header"
                    style="background-color: var(--color-navbar); border-bottom: 1px solid var(--color-background);">
                    <h5 class="mb-0">Version History Details</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>History ID:</strong> [[ historyObj.id ]]
                        </div>
                        <div class="col-md-3">
                            <strong>Version:</strong> <span class="badge bg-primary">[[ historyObj.version ]]</span>
                        </div>
                        <div class="col-md-3">
                            <strong title="Current status of this version">Status:</strong>
                            <span class="badge"
                                :class="{'bg-success': historyObj.status === 'accepted', 'bg-danger': historyObj.status === 'rejected', 'bg-warning': historyObj.status === 'pending'}">
                                [[ historyObj.status ]]</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Created At:</strong> <span class="text-muted small"
                                style="color: var(--color-text) !important;">[[ historyObj.created_at ]]</span>
                        </div>
                    </div>
                    <hr style="border-top: 1px solid var(--color-background);">
                    <div>
                        <strong>Comment:</strong>
                        <p class="fst-italic">[[ historyObj.comment || 'No comment provided.' ]]</p>
                    </div>
                </div>
            </div>

            <div class="mb-4 p-3 rounded shadow-sm d-flex justify-content-between align-items-center"
                style="background-color: var(--color-sidebar); border: 1px solid var(--color-navbar);">
                [[ historyObj.user_id]]
                <div class="d-flex">
                    <button type="button" class="btn btn-success me-2" v-if="historyObj.status === 'pending'"
                        @click="historyAction(historyObj.id, 'accept')">Accept</button>
                    <button type="button" class="btn btn-danger" v-if="historyObj.status === 'pending'"
                        @click="historyAction(historyObj.id, 'reject')">Reject</button>
                </div>

                <div class="btn-group">
                    <button class="btn"
                        :class="{'btn-primary': filterMode === 'all', 'btn-outline-primary': filterMode !== 'all'}"
                        @click="toggleFilter('all')">Show All</button>

                    <button class="btn"
                        :class="{'btn-success': filterMode === 'add', 'btn-outline-success': filterMode !== 'add'}"
                        @click="toggleFilter('add')">Additions</button>

                    <button class="btn"
                        :class="{'btn-danger': filterMode === 'del', 'btn-outline-danger': filterMode !== 'del'}"
                        @click="toggleFilter('del')">Deletions</button>

                    <button class="btn"
                        :class="{'btn-secondary': filterMode === 'noempty', 'btn-outline-secondary': filterMode !== 'noempty'}"
                        @click="toggleFilter('noempty')">Hide Empty Lines</button>
                </div>


                <div class="d-flex align-items-center" style="color: var(--color-text);">
                    <span class="text-muted small me-3" style="color: var(--color-text) !important;">Display
                        Options:</span>

                    <div class="d-flex align-items-center">
                        <label for="heightRange" class="form-label mb-0 me-2 small text-muted"
                            style="color: var(--color-text) !important;">Panel Height ([[ panelHeight
                            ]]px):</label>
                        <input type="range" class="form-range" min="300" max="1000" step="50" id="heightRange"
                            v-model="panelHeight" style="width: 150px;">
                    </div>
                </div>
            </div>

            <hr style="border-top: 1px solid var(--color-text); opacity: 0.1;">

            <div v-if="old_result && new_result" class="row mt-4 mb-4">

                <div class="col-md-6 mb-4">
                    <div class="card h-100 shadow-lg" style="border: 1px solid var(--color-navbar); border-radius: 0;">
                        <div class="card-header d-flex justify-content-between align-items-center"
                            style="background-color: black ; color: white; border-radius: 0;">
                            <h5 class="mb-0">Original Output</h5>
                            <button class="btn btn-sm btn-outline-light" @click="copyText(old_result, $event)">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                            <span class="badge bg-danger">DELETIONS</span>
                        </div>
                        <div class="card-body p-0 json-panel" id="left-panel"
                            :style="{ maxHeight: panelHeight + 'px', height: panelHeight + 'px' }"
                            style="border-radius: 0;">
                            <pre v-html="leftHtml"></pre>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-4">
                    <div class="card h-100 shadow-lg" style="border: 1px solid var(--color-navbar); border-radius: 0;">
                        <div class="card-header  d-flex justify-content-between align-items-center"
                            style="background-color: black; color: white; border-radius: 0;">
                            <h5 class="mb-0">New Output</h5>
                            <button class="btn btn-sm btn-outline-light" @click="copyText(new_result, $event)">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                            <span class="badge bg-success">ADDITIONS</span>
                        </div>
                        <div class="card-body p-0 json-panel" id="right-panel"
                            :style="{ maxHeight: panelHeight + 'px', height: panelHeight + 'px' }"
                            style="border-radius: 0;">
                            <pre v-html="rightHtml"></pre>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-4 mb-5">
                    <a href="{{ url_for('convert.detail', id=convert_obj.id) }}"
                        class="btn btn-light border shadow-sm px-4 py-2 rounded-pill back-btn">
                        <i class="fas fa-arrow-left me-2"></i>
                        Back
                    </a>
                </div>

            </div>
            <div v-else class="text-center text-muted mt-5">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
                <p class="mt-3">Loading conversion results...</p>
            </div>
        </div>

    </template>

</div>
{% endblock %}

{% block script %}
<script src="https://cdn.jsdelivr.net/npm/diff@5.1.0/dist/diff.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism-themes/1.9.0/prism-one-dark.min.css">

<script type="module">
    const { createApp, ref, nextTick } = Vue;
    import { display_toast, message_list, create_message } from '/static/js/toaster.js';
    createApp({
        delimiters: ['[[', ']]'],
        setup() {

            const old_result = ref(`{{ old_result | tojson | safe }}`);
            const new_result = ref(`{{ new_result | tojson | safe }}`);
            const history_id = "{{ history_id }}";

            const historyObj = ref({});
            const leftHtml = ref('');
            const rightHtml = ref('');

            const is_loading = ref(true);

            const panelHeight = ref(520);

            async function fetchConvert() {
                const param = new URLSearchParams({
                    history_id: history_id
                });
                const response = await fetch(`/convert/get_history_details?${param.toString()}`);
                const data = await response.json();
                if (data.success) {
                    historyObj.value = data.history;
                }
            }


            function prettyJSON(jsonString) {
                try {
                    return JSON.stringify(JSON.parse(jsonString), null, 2);
                }
                catch (e) { return String(jsonString); }
            }

            function buildDiffHtml(oldStr, newStr) {
                const parts = Diff.diffLines(oldStr, newStr);

                const oldPretty = prettyJSON(oldStr);
                const newPretty = prettyJSON(newStr);

                const oldLines = Prism.highlight(oldPretty, Prism.languages.json, 'json').split('\n');
                const newLines = Prism.highlight(newPretty, Prism.languages.json, 'json').split('\n');

                let oi = 0, ni = 0;
                const leftParts = [], rightParts = [];
                let leftLineNumber = 1;
                let rightLineNumber = 1;

                for (const part of parts) {
                    const lines = part.value.split('\n');
                    const lineCount = (part.value.endsWith('\n') ? lines.length - 1 : lines.length);

                    if (part.removed) {
                        for (let i = 0; i < lineCount; i++) {
                            leftParts.push(`<div class="line removed"><span class="line-num">${leftLineNumber}</span><span class="line-content">${oldLines[oi++] || '&nbsp;'}</span></div>`);
                            rightParts.push(`<div class="line empty"><span class="line-num">&nbsp;</span><span class="line-content">&nbsp;</span></div>`);
                            leftLineNumber++;
                        }
                    } else if (part.added) {
                        for (let i = 0; i < lineCount; i++) {
                            leftParts.push(`<div class="line empty"><span class="line-num">&nbsp;</span><span class="line-content">&nbsp;</span></div>`);
                            rightParts.push(`<div class="line added"><span class="line-num">${rightLineNumber}</span><span class="line-content">${newLines[ni++] || '&nbsp;'}</span></div>`);
                            rightLineNumber++;
                        }
                    } else {
                        for (let i = 0; i < lineCount; i++) {
                            leftParts.push(`<div class="line"><span class="line-num">${leftLineNumber}</span><span class="line-content">${oldLines[oi++] || '&nbsp;'}</span></div>`);
                            rightParts.push(`<div class="line"><span class="line-num">${rightLineNumber}</span><span class="line-content">${newLines[ni++] || '&nbsp;'}</span></div>`);
                            leftLineNumber++;
                            rightLineNumber++;
                        }
                    }
                }

                return { left: leftParts.join(''), right: rightParts.join('') };
            }

            function runDiffAndRender() {
                const oldStr = old_result.value;
                const newStr = new_result.value;

                if (oldStr && newStr) {
                    const { left, right } = buildDiffHtml(oldStr, newStr);
                    leftHtml.value = left;
                    rightHtml.value = right;
                }
            }

            async function loadAllData() {
                try {
                    await fetchConvert();
                    runDiffAndRender();

                } catch (error) {
                    console.error("Error loading data:", error);
                } finally {
                    is_loading.value = false;

                    nextTick(() => {
                        const leftPanel = document.getElementById('left-panel');
                        const rightPanel = document.getElementById('right-panel');

                        if (leftPanel && rightPanel) {
                            function syncScroll(e) {
                                if (e.target === leftPanel) {
                                    rightPanel.scrollTop = leftPanel.scrollTop;
                                    rightPanel.scrollLeft = leftPanel.scrollLeft;
                                } else if (e.target === rightPanel) {
                                    leftPanel.scrollTop = rightPanel.scrollTop;
                                    leftPanel.scrollLeft = rightPanel.scrollLeft;
                                }
                            }

                            leftPanel.addEventListener('scroll', syncScroll);
                            rightPanel.addEventListener('scroll', syncScroll);
                        }
                    });
                }
            }

            loadAllData();


            async function historyAction(id, action) {
                const params = new URLSearchParams({
                    history_id: id,
                    action: action
                });

                const res = await fetch(`/convert/history_action?` + params.toString());
                const data = await res.json();

                if (data.success) {
                    window.location.href = `/convert/refresh/${"{{convert_obj.uuid}}"}`;
                } else {
                    create_message(data.message, data.toast_class);
                }
            }


            const filterMode = ref("all");

            function toggleFilter(mode) {
                if (filterMode.value === mode) {
                    filterMode.value = "all";
                    applyFilter("all");
                } else {
                    filterMode.value = mode;
                    applyFilter(mode);
                }
            }


            function applyFilter(mode) {
                filterMode.value = mode;

                const leftPanel = document.getElementById("left-panel");
                const rightPanel = document.getElementById("right-panel");

                if (!leftPanel || !rightPanel) return;

                const leftLines = leftPanel.querySelectorAll(".line");
                const rightLines = rightPanel.querySelectorAll(".line");

                // Always reset both sides as visible
                leftLines.forEach(line => line.style.display = "");
                rightLines.forEach(line => line.style.display = "");

                // Apply filter only to the relevant panel
                if (mode === "add") {
                    // Filter ONLY right panel
                    rightLines.forEach(line => {
                        const isAdded = line.classList.contains("added");
                        line.style.display = isAdded ? "" : "none";
                    });
                    // Left panel stays fully visible
                }

                else if (mode === "del") {
                    // Filter ONLY left panel
                    leftLines.forEach(line => {
                        const isRemoved = line.classList.contains("removed");
                        line.style.display = isRemoved ? "" : "none";
                    });
                    // Right panel stays fully visible
                }

                else if (mode === "noempty") {
                    // Filter both panels, hide only empty lines
                    leftLines.forEach(line => {
                        const isEmpty = line.classList.contains("empty");
                        line.style.display = isEmpty ? "none" : "";
                    });

                    rightLines.forEach(line => {
                        const isEmpty = line.classList.contains("empty");
                        line.style.display = isEmpty ? "none" : "";
                    });
                }

                // mode === "all" â†’ everything stays visible (already reset)
            }


            function copyText(text, event) {
                const btn = event.target.closest("button")
                const originalHTML = btn.innerHTML
                navigator.clipboard.writeText(text).then(() => {
                    btn.innerHTML = '<i class="fas fa-check"></i> Copied!'
                    setTimeout(() => { btn.innerHTML = originalHTML }, 1500)
                }).catch(err => console.error('Copy failed', err))
            }


            return {
                old_result,
                new_result,
                leftHtml,
                rightHtml,
                historyObj,
                panelHeight,
                historyAction,
                is_loading,
                applyFilter,
                filterMode,
                toggleFilter,
                copyText
            };
        }
    }).mount('#main-container');
</script>

{% endblock %}