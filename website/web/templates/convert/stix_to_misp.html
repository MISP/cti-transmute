{% extends "base.html" %}

{% block content %}
<div id="main-container" class="container my-5">
    <h2 class=" mb-3">Convert STIX to MISP</h2>

    <!-- Help / Parameters Panel -->
    <div class="card mb-4 bg-dark text-light">
        <div class="card-header d-flex justify-content-between align-items-center" 
             data-bs-toggle="collapse" data-bs-target="#helpPanel" style="cursor: pointer;">
            <span>Help / Parameters</span>
            <i class="fas fa-chevron-down"></i>
        </div>
        <div id="helpPanel" class="collapse">
            <div class="card-body">
                <ul>
                    <li><strong>distribution</strong> (0-4): Distribution level for the imported MISP content</li>
                    <li><strong>sharing_group_id</strong> (integer): Required if distribution is 4</li>
                    <li><strong>galaxies_as_tags</strong> (bool): Import MISP Galaxies as tags instead of standard format</li>
                    <li><strong>no_force_contextual_data</strong> (bool): Skip forced creation of custom Galaxy clusters</li>
                    <li><strong>cluster_distribution</strong> (0-4): Distribution level for Galaxy clusters</li>
                    <li><strong>cluster_sharing_group_id</strong> (integer)</li>
                    <li><strong>organisation_uuid</strong> (string)</li>
                    <li><strong>single_event</strong> (bool): Convert to a single MISP event if multiple</li>
                    <li><strong>producer</strong> (string)</li>
                    <li><strong>title</strong> (string)</li>
                </ul>
            </div>
        </div>
    </div>

    <form method="post" enctype="multipart/form-data">
        {{ form.hidden_tag() }}

        <!-- Fichier -->
        <div class="mb-4">
            <label for="file" class="form-label">STIX File <span class="text-danger">*</span></label>
            <input type="file" class="form-control" id="file" name="file" required  style="background-color:var(--color-navbar); color:var(--color-text);">
        </div>

        <!-- Nom et description -->
        <div class="row mb-3">
            <div class="col-md-6">
                {{ form.name.label(class_="form-label") }} 
                {{ form.name(class_="form-control" , style="background-color:var(--color-navbar); color:var(--color-text);" , placeholder="Enter a name for the conversion") }}
                {% for err in form.name.errors %}
                    <div class="invalid-feedback d-block">{{ err }}</div>
                {% endfor %}
            </div>
            <div class="col-md-6">
                {{ form.description.label(class_="form-label") }}
                {{ form.description(class_="form-control", placeholder="Optional description..." , style="background-color:var(--color-navbar); color:var(--color-text);") }}
            </div>
        </div>

        <!-- Distribution + Sharing Group -->
        <div class="row mb-3">
            <div class="col-md-6">
                <label for="distribution" class="form-label">Distribution Level</label>
                <select class="form-select" id="distribution" name="distribution" style="background-color:var(--color-navbar); color:var(--color-text);">
                    <option value="0" {% if form.distribution.data == 0 %}selected{% endif %}>0 – Your organisation only</option>
                    <option value="1" {% if form.distribution.data == 1 %}selected{% endif %}>1 – This community only</option>
                    <option value="2" {% if form.distribution.data == 2 %}selected{% endif %}>2 – Connected communities</option>
                    <option value="3" {% if form.distribution.data == 3 %}selected{% endif %}>3 – All communities</option>
                    <option value="4" {% if form.distribution.data == 4 %}selected{% endif %}>4 – Sharing Group</option>
                </select>
                {% for err in form.distribution.errors %}
                    <div class="invalid-feedback d-block">{{ err }}</div>
                {% endfor %}
            </div>
            <div class="col-md-6">
                {{ form.sharing_group_id.label(class_="form-label") }}
                {{ form.sharing_group_id(class_="form-control", placeholder="Only if distribution = 4" , style="background-color:var(--color-navbar); color:var(--color-text);") }}
            </div>
        </div>

        <!-- Cluster Distribution + Sharing Group -->
        <div class="row mb-3">
            <div class="col-md-6">
                <label for="cluster_distribution" class="form-label">Cluster Distribution Level</label>
                <select class="form-select" id="cluster_distribution" name="cluster_distribution"  style="background-color:var(--color-navbar); color:var(--color-text);">
                    <option value="0" {% if form.cluster_distribution.data == 0 %}selected{% endif %}>0 – Your organisation only</option>
                    <option value="1" {% if form.cluster_distribution.data == 1 %}selected{% endif %}>1 – This community only</option>
                    <option value="2" {% if form.cluster_distribution.data == 2 %}selected{% endif %}>2 – Connected communities</option>
                    <option value="3" {% if form.cluster_distribution.data == 3 %}selected{% endif %}>3 – All communities</option>
                    <option value="4" {% if form.cluster_distribution.data == 4 %}selected{% endif %}>4 – Sharing Group</option>
                </select>
            </div>
            <div class="col-md-6">
                {{ form.cluster_sharing_group_id.label(class_="form-label") }}
                {{ form.cluster_sharing_group_id(class_="form-control", placeholder="Only if cluster distribution = 4" , style="background-color:var(--color-navbar); color:var(--color-text);") }}
            </div>
        </div>

        <!-- Organisation + Producer -->
        <div class="row mb-3">
            <div class="col-md-6">
                {{ form.organisation_uuid.label(class_="form-label") }}
                {{ form.organisation_uuid(class_="form-control", placeholder="Organisation UUID (optional)" , style="background-color:var(--color-navbar); color:var(--color-text);") }}
            </div>
            <div class="col-md-6">
                {{ form.producer.label(class_="form-label") }}
                {{ form.producer(class_="form-control", placeholder="Producer of the STIX data" , style="background-color:var(--color-navbar); color:var(--color-text);") }}
            </div>
        </div>

        <!-- Title -->
        <div class="mb-3">
            {{ form.title.label(class_="form-label") }}
            {{ form.title(class_="form-control", placeholder="Optional title for the resulting MISP Event" , style="background-color:var(--color-navbar); color:var(--color-text);") }}
        </div>

        <!-- Switches -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="form-check form-switch">
                    {{ form.public(class_="form-check-input", id="publicSwitch") }}
                    {{ form.public.label(class_="form-check-label", for="publicSwitch" ) }}
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-check form-switch">
                    {{ form.galaxies_as_tags(class_="form-check-input", id="galaxiesSwitch") }}
                    {{ form.galaxies_as_tags.label(class_="form-check-label", for="galaxiesSwitch") }}
                    <small class="text-muted d-block">Import galaxies as simple tag names</small>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-check form-switch">
                    {{ form.no_force_contextual_data(class_="form-check-input", id="contextSwitch") }}
                    {{ form.no_force_contextual_data.label(class_="form-check-label", for="contextSwitch") }}
                    <small class="text-muted d-block">Avoid forcing ambiguous Galaxy cluster creation</small>
                </div>
            </div>
        </div>

        <!-- Single Event -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="form-check form-switch">
                    {{ form.single_event(class_="form-check-input", id="singleEventSwitch") }}
                    {{ form.single_event.label(class_="form-check-label", for="singleEventSwitch") }}
                    <small class="text-muted d-block">Convert STIX data into one MISP event</small>
                </div>
            </div>
        </div>

        <!-- Bouton Convert -->
        <div class="text-end">
            <button type="submit" class="btn btn-primary">{{ form.convert.label }}</button>
        </div>
    </form>



    <!-- Conversion Result / Error -->
    {% if result %}
        <div class="card bg-secondary text-light mt-4">
            <div class="card-body">
                <h5>Conversion Result:</h5>

                <div class="mt-3 d-flex gap-2 mb-3">
                    <button class="btn btn-outline-light btn-sm copy-btn">
                        <i class="fas fa-copy me-1"></i> <span class="btn-text">Copy</span>
                    </button>
                    <button class="btn btn-outline-light btn-sm download-btn">
                        <i class="fas fa-download me-1"></i> <span class="btn-text">Download</span>
                    </button>
                </div>

                <pre id="result-json" class="text-light">{{ result | tojson(indent=2) }}</pre>

                <div class="mt-3 d-flex gap-2">
                    <button class="btn btn-outline-light btn-sm copy-btn">
                        <i class="fas fa-copy me-1"></i> <span class="btn-text">Copy</span>
                    </button>
                    <button class="btn btn-outline-light btn-sm download-btn">
                        <i class="fas fa-download me-1"></i> <span class="btn-text">Download</span>
                    </button>
                </div>
            </div>
        </div>
    {% elif error %}
        <div class="card bg-danger text-light mt-4">
            <div class="card-body">
                <h5>Error:</h5>
                <pre class="text-light">{{ error }}</pre>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block script %}
<script type="module">
const { createApp, ref, onMounted } = Vue
createApp({
    delimiters: ['[[', ']]'],
    setup() {
        const result = ref('')

        onMounted(() => {
            const resultPre = document.getElementById('result-json')

            document.querySelectorAll(".copy-btn").forEach(copyBtn => {
                copyBtn.addEventListener('click', () => {
                    if (!resultPre) return
                    navigator.clipboard.writeText(resultPre.textContent)
                        .then(() => {
                            const textSpan = copyBtn.querySelector(".btn-text")
                            const originalText = textSpan.textContent
                            textSpan.textContent = "Copied"
                            setTimeout(() => {
                                textSpan.textContent = originalText
                            }, 2000)
                        })
                        .catch(err => console.error("Failed to copy:", err))
                })
            })

            document.querySelectorAll(".download-btn").forEach(downloadBtn => {
                downloadBtn.addEventListener('click', () => {
                    if (!resultPre) return
                    const blob = new Blob([resultPre.textContent], { type: 'application/json' })
                    const url = URL.createObjectURL(blob)
                    const a = document.createElement('a')
                    a.href = url
                    a.download = 'converted_misp.json'
                    document.body.appendChild(a)
                    a.click()
                    document.body.removeChild(a)
                    URL.revokeObjectURL(url)

                    const textSpan = downloadBtn.querySelector(".btn-text")
                    const originalText = textSpan.textContent
                    textSpan.textContent = "Downloaded"
                    setTimeout(() => {
                        textSpan.textContent = originalText
                    }, 2000)
                })
            })

            const clickableCard = document.querySelector(".clickable-card")
            if (clickableCard) {
                clickableCard.addEventListener("click", () => {
                    const url = clickableCard.dataset.url
                    window.location.href = url
                })
            }
        })

        return { result }
    }
}).mount('#main-container')
</script>
{% endblock %}
