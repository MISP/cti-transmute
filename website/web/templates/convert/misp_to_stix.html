{% extends "base.html" %}

{% block content %}
<div class="container my-4">
    <h2 class="text-info mb-3">Convert MISP â†’ STIX</h2>

    <form method="post" enctype="multipart/form-data">
        {{ form.hidden_tag() }}

        <div class="mb-3">
            {{ form.version.label(class_="form-label") }} <span class="text-danger">*</span>
            {{ form.version(class_="form-select") }}
            {% for err in form.version.errors %}
                <div class="invalid-feedback d-block">{{ err }}</div>
            {% endfor %}
        </div>

        <div class="mb-3">
            <label for="file" class="form-label">MISP File <span class="text-danger">*</span></label>
            <input type="file" class="form-control" id="file" name="file" required>
        </div>

        <button type="submit" class="btn btn-primary">{{ form.convert.label }}</button>
    </form>

    {% if result %}
        <div class="card bg-secondary text-light mt-4">
            <div class="card-body">
                <h5>Conversion Result:</h5>
                <pre id="result-json" class="text-light">{{ result | tojson(indent=2) }}</pre>

                <!-- Panel for copy / download -->
                <div class="mt-3 d-flex gap-2">
                    <button id="copy-btn" class="btn btn-outline-light btn-sm">
                        <i class="fas fa-copy me-1"></i> Copy
                    </button>
                    <button id="download-btn" class="btn btn-outline-light btn-sm">
                        <i class="fas fa-download me-1"></i> Download
                    </button>
                </div>
            </div>
        </div>
    {% elif error %}
        <div class="card bg-danger text-light mt-4">
            <div class="card-body">
                <h5>Error:</h5>
                <pre class="text-light">{{ error }}</pre>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block script %}
<script type="module">
const { createApp, ref, onMounted } = Vue
createApp({
    delimiters: ['[[', ']]'],
    setup() {
        const result = ref('')

        onMounted(() => {
            const copyBtn = document.getElementById('copy-btn')
            const downloadBtn = document.getElementById('download-btn')
            const resultPre = document.getElementById('result-json')

            if (copyBtn && resultPre) {
                copyBtn.addEventListener('click', () => {
                    navigator.clipboard.writeText(resultPre.textContent)
                        .then(() => {
                            const originalText = copyBtn.textContent
                            copyBtn.textContent = "Copied"
                            setTimeout(() => {
                                copyBtn.textContent = originalText
                            }, 2000)
                        })
                        .catch(err => {
                            console.error("Failed to copy:", err)
                        })
                })
            }

            if (downloadBtn && resultPre) {
                downloadBtn.addEventListener('click', () => {
                    const blob = new Blob([resultPre.textContent], { type: 'application/json' })
                    const url = URL.createObjectURL(blob)
                    const a = document.createElement('a')
                    a.href = url
                    a.download = 'converted_stix.json'
                    document.body.appendChild(a)
                    a.click()
                    document.body.removeChild(a)
                    URL.revokeObjectURL(url)
                })
            }
        })

        return { result }
    }
}).mount('#main-container')
</script>
{% endblock %}
