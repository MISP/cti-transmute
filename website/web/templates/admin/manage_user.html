{% extends "base.html" %}

{% block content %}
{% if not current_user.is_admin() %}
<script>
  window.location.href = "/access_denied";
</script>
{% else %}

<div class="container my-5" id="main-container">
    <h2 class="mb-4">User Management</h2>

    <div class="mb-3">
        <div class="row g-2 align-items-center" >
            <!-- Search bar -->
            <div class="col-md-4">
                <input  type="text"  class="form-control"  placeholder="Search users..." v-model="searchQuery"  @input="onSearchInput"  @keyup.enter="onEnterKey" style="background-color:var(--color-navbar); color:var(--color-text);">
            </div>

            <!-- Connected filter -->
            <div class="col-md-3">
                <select class="form-select" v-model="filterConnection" @change="onSearchInput" style="background-color:var(--color-navbar); color:var(--color-text);">
                    <option value="all"  selected>All users</option>
                    <option value="connected">Connected only</option>
                    <option value="disconnected">Disconnected only</option>
                </select>
            </div>

            <!-- Admin filter -->
            <div class="col-md-3">
                <select class="form-select" v-model="filterAdmin" @change="onSearchInput" style="background-color:var(--color-navbar); color:var(--color-text);">
                    <option value="all" selected>All roles</option>
                    <option value="admin">Admins only</option>
                    <option value="user">Non-admins only</option>
                </select>
            </div>
        </div>
    </div>



    <div class="user-list">
        <div  v-for="user in users" :key="user.id" class="user-item mb-3 p-3 border rounded shadow-sm" class="card" id="card-item">
            <div  class="d-flex justify-content-between align-items-center"role="button" @click="seeUserDetail(user.id)" >
                <div class="d-flex flex-column">
                    <h5 class="mb-1">[[ user.first_name ]] [[ user.last_name ]]</h5>
                    <small>[[ user.email ]]</small>
                </div>

                <div class="d-flex align-items-center gap-2">
                    <span  v-if="user.admin"  class="badge bg-secondary">Admin</span>
                    <span  v-if="user.is_connected"  class="badge bg-success" >Online</span>
                    <span  v-else class="badge bg-danger">Offline</span>
                    <i class="bi bi-chevron-down small"></i>
                </div>
            </div>
        </div>
    </div>

    <div v-if="users.length > 0" >
        <nav aria-label="Page navigation" style="margin-bottom: 100px;">
            <ul class="pagination justify-content-center mt-3">
                <li class="page-item" :class="{ disabled: current_page === 1 }">
                    <button class="page-link" @click="current_page > 1 && fetchUser(current_page - 1)">
                        <i class="fa-solid fa-angle-left"></i>
                    </button>
                </li>
                <li class="page-item"
                    v-for="page in visiblePages"
                    :key="page"
                    :class="{ active: page === current_page, disabled: page === '...' }">
                    <button class="page-link" v-if="page !== '...'" @click="fetchUser(page)">
                        [[ page ]]
                    </button>
                    <span class="page-link" v-else>...</span>
                </li>

                <li class="page-item" :class="{ disabled: current_page === total_pages }">
                    <button class="page-link" @click="current_page < total_pages && fetchUser(current_page + 1)">
                        <i class="fa-solid fa-angle-right"></i>
                    </button>
                </li>
            </ul>
        </nav>
    </div>
</div>
{% endif %}
{% endblock %}

{% block script %}
<script type="module">
const { createApp, ref,computed } = Vue
import { display_toast, message_list, display_prepared_toast } from '/static/js/toaster.js'

createApp({
  delimiters: ['[[', ']]'],
  setup() {
    const users = ref([])
    const current_page = ref(1)
    const total_pages = ref(1)

    const searchQuery = ref('')
    const filterConnection = ref("all")
    const filterAdmin = ref("all")

    async function fetchUser(page = 1) {
      if (page < 1) return
      const params = new URLSearchParams({
        page: page,
        searchQuery: searchQuery.value || '',
        filterConnection: filterConnection.value || '',
        filterAdmin: filterAdmin.value || ''
      })
      const res = await fetch('/account/get_users?' + params.toString())
      if (res.ok) {
        const data = await res.json()
        users.value = data.list || []
        total_pages.value = data.total_page || 1
        current_page.value = page
      } 
    }

    async function onSearchInput() {
      await fetchUser(1)
    }

    async function onEnterKey() {
      await fetchUser(1)
    }

    function seeUserDetail(id){
        window.location.href = "/account/detail_user/"+id;
    }

    fetchUser(1)

    const visiblePages = computed(() => {
        const pages = []
        const total = total_pages.value
        const current = current_page.value
        if (total <= 7) {
        for (let i = 1; i <= total; i++) pages.push(i)
        } else {
        if (current <= 4) {
            pages.push(1, 2, 3, 4, 5, '...', total)
        } else if (current >= total - 3) {
            pages.push(1, '...', total - 4, total - 3, total - 2, total - 1, total)
        } else {
            pages.push(1, '...', current - 1, current, current + 1, '...', total)
        }
        }
        return pages
    })

    return {
      users,
      current_page,
      total_pages,
      searchQuery,
      fetchUser,
      onSearchInput,
      onEnterKey,
      message_list,
      visiblePages,
      filterConnection,
      filterAdmin,
      seeUserDetail
    }
  }
}).mount('#main-container')
</script>
{% endblock %}
